# Session Context - Claude Handoff Document

**Last Updated:** 2025-12-24
**Version:** Auto-generated by CI (Executive Power)
**Status:** TASK-002 COMPLETE + Auto-Versioning Implemented

---

## Current State

| Item | Status |
|------|--------|
| Production | Stable (version auto-managed by CI) |
| Git | All committed, build triggered |
| TASK-002 | **COMPLETE** - 6 UI fixes done |
| Auto-Versioning | **NEW** - CI has executive power |
| Tests | 539 pass (518 unified + 21 column) |

---

## Auto-Versioning (NEW - 2025-12-24)

**CI now has EXECUTIVE POWER over version numbers!**

### How It Works
1. Trigger build → CI generates `vMMDDHHMM` (KST)
2. CI updates ALL 12 files automatically
3. CI commits: `build: Auto-version vXXXX [skip ci]`
4. Installer filename matches: `VRSManager_vXXXX_Light_Setup.exe`

### Files Auto-Updated
- `src/config.py`, `main.py`, `README.md`, `README_KR.md`
- `CLAUDE.md`, `roadmap.md`, `docs/WIKI_CONFLUENCE.md`
- `installer/*.iss`, `scripts/update_excel_guides.py`
- `src/processors/master_processor.py`

### Key Rule
**DO NOT manually update version numbers!** CI handles everything.

---

## V5 UI Fixes (Previous Session)

### Issues Fixed

| Issue | Problem | Fix |
|-------|---------|-----|
| **V5-001** | FIXED columns truncated ("...10 total") | Show full comma-separated list with wraplength |
| **V5-002** | Previous_ prefix shown in checkboxes | Removed - user sees original column name |
| **V5-003** | "New Rows" text unclear | Clarified: "Rows that only exist in CURRENT..." |
| **V5-004** | Previous_ prefix on ALL columns | Only add prefix on CONFLICT (both files) |
| **V5-005** | Dialog too small, buttons compressed | Increased to 950x850 / minsize 850x750 |
| **V5-006** | Upload freezes UI | Threading + progress feedback |

### Files Modified
- `src/ui/main_window.py` - UI fixes + threading
- `src/settings.py` - Prefix conflict logic
- `src/core/working_comparison.py` - Handle prefixed/non-prefixed
- `docs/wip/ISSUELIST.md` - Issue tracking

### Column Selection Persistence
Settings apply to ALL future WORKING processor runs:
- Analyzed file is for DISCOVERY only
- Settings persist in `~/.vrsmanager_settings.json`
- Any future file processed will try to find configured columns

---

## Config Persistence (Already Implemented)

### How It Works

| Action | Result |
|--------|--------|
| **SAVE** | Saves to `~/.vrsmanager_settings.json` |
| **Open Dialog** | Loads saved selections, pre-populates checkboxes |
| **RESET ALL** | Clears JSON config, shows empty upload boxes |

### User Flow
1. Upload CURRENT file → select columns
2. Upload PREVIOUS file → select columns
3. Click SAVE → selections persisted to JSON
4. Next time open dialog → previous selections remembered
5. Want to change? → RESET ALL + REUPLOAD

### Previous_ Prefix Handling (CONFLICT RESOLUTION)

The prefix is ONLY added when there's a CONFLICT (same column selected from BOTH files):

| Scenario | Output Column Name |
|----------|-------------------|
| FREEMEMO only in PREVIOUS | `FREEMEMO` (no prefix) |
| FREEMEMO only in CURRENT | `FREEMEMO` (no prefix) |
| FREEMEMO in BOTH (conflict) | `FREEMEMO` (CURRENT) + `Previous_FREEMEMO` (PREVIOUS) |

**Logic in `get_v5_enabled_columns()`:**
```python
for col in selected_previous:
    if col in enabled_current:
        # CONFLICT: add prefix
        enabled_previous.append(f"Previous_{col}")
    else:
        # NO CONFLICT: no prefix
        enabled_previous.append(col)
```

---

## TASK-002: V5 Implementation (COMPLETE)

### What Was Implemented

1. **Backend: KEY-based PREVIOUS Column Extraction**
   - `src/core/working_comparison.py`: Added V5 PREVIOUS column extraction in the processing loop
   - Uses existing KEY-matching (SequenceName+EventName+StrOrigin+CastingKey)
   - For each CURRENT row, extracts selected columns from matched PREVIOUS row
   - New rows (no KEY match) get empty PREVIOUS values

2. **Data Processing: V5 Column Filtering**
   - `src/utils/data_processing.py`: Updated `filter_output_columns()` to include V5 columns
   - Includes V5 auto-generated, current, and previous columns in output

3. **UI: Dual File Upload (Already Existed)**
   - `src/ui/main_window.py`: Already had V5 dual upload boxes implemented
   - CURRENT file box (green) and PREVIOUS file box (blue)
   - Previous_ prefix added to PREVIOUS columns in display

4. **Settings: V5 Schema (Already Existed)**
   - `src/settings.py`: Already had V5 functions
   - `get_v5_column_settings()`, `set_v5_current_file()`, `set_v5_previous_file()`
   - `get_v5_enabled_columns()` returns Previous_ prefixed columns

5. **Tests: V5 Test Suite**
   - `tests/test_column_classification.py`: Added 6 new V5 tests
   - All 21 tests pass

### Key Technical Details

```python
# In working_comparison.py (simplified):
v5_cols = get_v5_enabled_columns()
selected_previous_cols = v5_cols.get("previous", [])  # e.g., ["Previous_FREEMEMO"]

for prefixed_col in selected_previous_cols:
    if prefixed_col.startswith("Previous_"):
        original_col = prefixed_col[9:]  # "FREEMEMO"
        if prev_row_dict and change_type != "New Row":
            # KEY-matched: extract from matched PREVIOUS row
            curr_dict[prefixed_col] = safe_str(prev_row_dict.get(original_col, ""))
        else:
            curr_dict[prefixed_col] = ""  # New Row
```

### Files Modified (This Session)

```
src/core/working_comparison.py   # V5: PREVIOUS column KEY-based extraction
src/utils/data_processing.py     # V5: filter_output_columns includes V5 columns
tests/test_column_classification.py  # V5: 6 new tests (21 total)
```

---

## V5 UI Design (Reference)

```
┌────────────────────────────────────────────────────────────────────────────┐
│ COLUMN SETTINGS                                               [X]          │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│ FIXED COLUMNS (Always Included)                                            │
│ ┌────────────────────────────────────────────────────────────────────────┐ │
│ │ ✓ MANDATORY (10): SequenceName, EventName, StrOrigin, CharacterKey... │ │
│ │ ✓ VRS CONDITIONAL (10): Desc, DialogType, Group, StartFrame...        │ │
│ └────────────────────────────────────────────────────────────────────────┘ │
│                                                                            │
│ AUTO-GENERATED (Toggle ON/OFF)                                             │
│ ☑ PreviousData  ☑ PreviousText  ☑ DETAILED_CHANGES  ☐ Mainline...        │
│                                                                            │
├────────────────────────────────────────────────────────────────────────────┤
│ OPTIONAL COLUMNS                                          [RESET ALL]      │
│                                                                            │
│  ┌─── FROM CURRENT FILE ───────┐    ┌─── FROM PREVIOUS FILE ──────┐       │
│  │ myfile_v2.xlsx ✓            │    │ myfile_v1.xlsx ✓            │       │
│  │                             │    │                             │       │
│  │ ☑ FREEMEMO                  │    │ ☐ Previous_FREEMEMO         │       │
│  │ ☑ HasAudio                  │    │ ☐ Previous_HasAudio         │       │
│  │ ☐ Record                    │    │ ☐ Previous_Record           │       │
│  │                             │    │                             │       │
│  │ [Upload] [All] [None]       │    │ [Upload] [All] [None]       │       │
│  └─────────────────────────────┘    └─────────────────────────────┘       │
│                                                                            │
│ ℹ️ PREVIOUS columns matched by KEY (Seq+Event+StrOrigin+CastingKey).       │
│   New Rows will have empty PREVIOUS values.                                │
│                                                                            │
│                                              [Back]    [Save]              │
└────────────────────────────────────────────────────────────────────────────┘
```

---

## V4 Implementation (COMPLETE - Reference)

### 4-Tier Column Classification System

| Category | Count | Behavior | UI |
|----------|-------|----------|-----|
| **MANDATORY** | 10 | Always included, cannot disable | Green ✓ info section |
| **VRS_CONDITIONAL** | 10 | Used in change detection, always from CURRENT | Blue ✓ info section |
| **AUTO-GENERATED** | 6 | Created by VRS logic, toggleable | Purple checkboxes |
| **OPTIONAL** | 7 | Extra metadata only, toggleable | Orange checkboxes |

### Column Details

**MANDATORY (10):** SequenceName, EventName, StrOrigin, CharacterKey, CharacterName, CastingKey, DialogVoice, Text, STATUS, CHANGES

**VRS_CONDITIONAL (10):** Desc, DialogType, Group, StartFrame, EndFrame, Tribe, Age, Gender, Job, Region

**AUTO-GENERATED (6):** PreviousData, PreviousText, PreviousEventName, DETAILED_CHANGES, Previous StrOrigin, Mainline Translation

**OPTIONAL (7):** FREEMEMO, SubTimelineName, UpdateTime, HasAudio, UseSubtitle, Record, isNew

---

## Testing

```bash
# Run unified tests (518 tests)
python3 tests/test_unified_change_detection.py

# Run column classification tests (21 tests including V5)
python3 tests/test_column_classification.py

# Check version
python3 scripts/check_version_unified.py
```

All tests pass:
- 518/518 unified tests
- 21/21 column classification tests (including 6 new V5 tests)

---

## Next Steps

1. **Manual Windows test** - Verify Column Settings dialog with dual upload
2. **Build and deploy** - Create new build with V5 functionality
3. **User testing** - Test with real PREVIOUS/CURRENT file pairs

---

## Key Clarifications

- **CURRENT columns**: Extracted by NAME from CURRENT file (simple, direct)
- **PREVIOUS columns**: Extracted by KEY-matching from PREVIOUS file (robust)
- **New Rows**: PREVIOUS columns are empty (no KEY match)
- **Matched Rows**: PREVIOUS columns contain value from matched PREVIOUS row

---

*This document is the source of truth for session handoff.*
